<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>HEIC to JPEG Converter</title>
    <meta name="theme-color" content="#317EFB" />
    <link rel="stylesheet" href="style.css" />
    <link rel="manifest" href="manifest.json" />
    <link rel="apple-touch-icon" href="icons/icon-192x192.png" />
  </head>
  <body>
    <div class="container">
      <h1>HEIC to JPEG Converter</h1>
      <p>Hello World! Функционал конвертера будет добавлен позже.</p>
    </div>

    <!-- Постоянная кнопка установки в углу -->
    <button
      id="install-button"
      class="install-button-permanent"
      style="display: none"
      title="Установить приложение"
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        width="24"
        height="24"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"
      >
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
        <polyline points="7 10 12 15 17 10" />
        <line x1="12" y1="15" x2="12" y2="3" />
      </svg>
    </button>

    <!-- Подвал для отображения версии -->
    <footer>
      <p id="version-display"></p>
    </footer>

    <script>
      // --- ОТОБРАЖЕНИЕ ВЕРСИИ ---
      // ВАЖНО: Эта версия должна совпадать с CACHE_VERSION в service-worker.js
      const APP_VERSION = "0.0.2";
      document.getElementById(
        "version-display"
      ).textContent = `Версия: ${APP_VERSION}`;

      // --- ЛОГИКА SERVICE WORKER И ОБНОВЛЕНИЙ ---
      if ("serviceWorker" in navigator) {
        navigator.serviceWorker
          .register("/service-worker.js")
          .then((reg) => {
            console.log("Service worker зарегистрирован.");
          })
          .catch((error) => {
            console.log("Ошибка регистрации Service Worker:", error);
          });

        // При перезагрузке страницы, если новый сервис-воркер уже был, он станет активным
        // Это вызовет перезагрузку страницы для отображения обновленного контента
        navigator.serviceWorker.addEventListener("controllerchange", () => {
          console.log("Service Worker был обновлен. Перезагрузка страницы...");
          window.location.reload();
        });
      }

      // --- ЛОГИКА УСТАНОВКИ PWA ---
      let deferredPrompt;
      const permanentInstallButton = document.getElementById("install-button");

      window.addEventListener("beforeinstallprompt", (e) => {
        // Предотвращаем стандартное поведение браузера
        e.preventDefault();
        // Сохраняем событие, чтобы его можно было вызвать позже
        deferredPrompt = e;
        console.log("Событие beforeinstallprompt было перехвачено");

        // Показываем нашу кнопку установки
        permanentInstallButton.style.display = "flex";
      });

      // Клик по постоянной кнопке установки
      permanentInstallButton.addEventListener("click", async () => {
        if (deferredPrompt) {
          // Показываем стандартный диалог установки браузера
          deferredPrompt.prompt();
          const { outcome } = await deferredPrompt.userChoice;
          console.log(`Результат установки: ${outcome}`);
          // Обнуляем событие, так как оно одноразовое
          deferredPrompt = null;
          // Скрываем кнопку после вызова
          permanentInstallButton.style.display = "none";
        }
      });

      // Скрываем кнопку, если приложение уже установлено
      window.addEventListener("appinstalled", () => {
        console.log("Приложение было успешно установлено!");
        permanentInstallButton.style.display = "none";
        deferredPrompt = null;
      });
    </script>
  </body>
</html>
